<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RESERVA DE AULA DE INFORMÁTICA</title>
  <style>
    :root {
      --col-date-width: 110px;
      --col-session-width: 90px;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .top-bar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f5f5f5;
    }

    header {
      background: #2e7d32; /* VERDE */
      color: white;
      padding: 16px 24px 10px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      letter-spacing: 1px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      padding: 8px 24px 6px;
      background: #f5f5f5;
    }

    main {
      padding: 12px 16px 24px;
    }

    label {
      font-weight: 600;
    }

    select {
      padding: 4px 8px;
      font-size: 14px;
    }

    .legend {
      font-size: 12px;
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #aaa;
    }

    .legend-color.reserved {
      background: #e53935;
    }

    .legend-color.free {
      background: #ffffff;
    }

    .table-container {
      max-width: 100%;
      overflow: auto;
      border: 1px solid #ccc;
      background: white;
      border-radius: 4px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
      font-size: 12px;
      table-layout: fixed;
    }

    thead {
      background: #e1e9f2;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #c8e6c9; /* verde clarito */
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }

    thead th:nth-child(1),
    tbody td:nth-child(1) {
      width: var(--col-date-width);
    }

    thead th:nth-child(2),
    tbody td:nth-child(2) {
      width: var(--col-session-width);
    }

    thead th:nth-child(1),
    tbody td:nth-child(1) {
      position: sticky;
      left: 0;
      z-index: 11;
      background: #ffffff;
    }

    thead th:nth-child(2),
    tbody td:nth-child(2) {
      position: sticky;
      left: var(--col-date-width);
      z-index: 11;
      background: #ffffff;
    }

    tbody tr.day-a td {
      background: #ffffff;
    }

    tbody tr.day-b td {
      background: #e8f5e9; /* verde ultra suave */
    }

    td.reservable {
      cursor: pointer;
      transition: background 0.15s ease;
      position: relative;
    }

    td.reservable:hover {
      box-shadow: inset 0 0 0 2px #2e7d32;
    }

    td.reserved {
      background: #e53935 !important;
      color: #ffffff;
      font-weight: 700;
    }

    td.fixed-reserved {
      background: #1b5e20 !important; /* verde oscuro */
      color: #ffffff;
      font-weight: 700;
      cursor: default;
    }

    td.reservable::before {
      content: attr(data-class);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      color: rgba(0, 0, 0, 0.25);
      pointer-events: none;
      text-align: center;
      width: 100%;
    }

    td.reserved::before {
      color: rgba(255, 255, 255, 0.6);
    }

    td.fixed-reserved::before {
      color: rgba(255, 255, 255, 0.7);
    }

    .info {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>

<body>

<div class="top-bar">
  <header>
    <h1>RESERVA DE AULA DE INFORMÁTICA</h1>
  </header>

  <div class="controls">
    <div>
      <label for="monthSelect">Mes:</label>
      <select id="monthSelect"></select>
    </div>

    <div class="legend">
      <span class="legend-item"><span class="legend-color free"></span> Libre</span>
      <span class="legend-item"><span class="legend-color reserved"></span> Reservado</span>
      <span> Doble clic para reservar / liberar</span>
    </div>
  </div>
</div>

<main>
  <div class="table-container">
    <table id="calendarTable"></table>
  </div>

  <p class="info">
    * Las reservas pueden modificarse durante 2 minutos después de realizarse.
  </p>
  <p class="info">
    * En cada periodo de 24 horas solo se puede realizar una reserva por semana natural.
  </p>
</main>

<script type="module">
/* =============== FIREBASE =============== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore,
  doc,
  onSnapshot,
  setDoc,
  deleteField
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const UNRESERVE_WINDOW_MS = 2 * 60 * 1000;
const USER_RESERVATION_TTL_MS = 24 * 60 * 60 * 1000;

const firebaseConfig = {
  apiKey: "AIzaSyD5EAMg-0p54f8bPq8SVdZ_ePg5Xso3cmg",
  authDomain: "arm1-acbba.firebaseapp.com",
  projectId: "arm1-acbba",
  storageBucket: "arm1-acbba.firebasestorage.app",
  messagingSenderId: "408825932019",
  appId: "1:408825932019:web:10f2079b590b4c9ca3af86",
  measurementId: "G-S78TM6PVRL"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============== CONFIGURACIÓN =============== */

const months = [
  { year: 2025, month: 11, name: "Noviembre 2025" },
  { year: 2025, month: 12, name: "Diciembre 2025" },
  { year: 2026, month: 1, name: "Enero 2026" },
  { year: 2026, month: 2, name: "Febrero 2026" },
  { year: 2026, month: 3, name: "Marzo 2026" },
  { year: 2026, month: 4, name: "Abril 2026" },
  { year: 2026, month: 5, name: "Mayo 2026" },
  { year: 2026, month: 6, name: "Junio 2026" }
];

const classes = [
  "Infantil 3 años", "Infantil 4 años", "Infantil 5 años",
  "1ºA", "2ºA", "3ºA", "4ºA", "4ºB",
  "5ºA", "5ºB", "6ºA", "6ºB"
];

const defaultSlots = [
  "9:00-9:45",
  "9:45-10:30",
  "10:30-11:15",
  "11:45-12:30",
  "12:30-13:15",
  "13:15-14:00"
];

const juneSlots = [
  "9:00-9:40",
  "9:40-10:20",
  "10:20-11:00",
  "11:30-12:15",
  "12:15-13:00"
];

/* =============== RESERVAS FIJAS (CORREGIDAS) =============== */

const FIXED_WEEKLY_RESERVATIONS = [

  /* Sesión 1 */
  { weekday: 5, session: 1, className: "2ºA" }, // viernes

  /* Sesión 4 */
  { weekday: 3, session: 4, className: "3ºA" }, // miércoles
  { weekday: 4, session: 4, className: "5ºA" }, // jueves
  { weekday: 5, session: 4, className: "4ºB" }, // viernes

  /* Sesión 5 */
  { weekday: 1, session: 5, className: "4ºA" }, // lunes
  { weekday: 2, session: 5, className: "6ºB" }, // martes
  { weekday: 3, session: 5, className: "1ºA" }, // miércoles
  { weekday: 4, session: 5, className: "3ºA" }, // jueves

  /* Sesión 6 */
  { weekday: 1, session: 6, className: "4ºB" }, // lunes
  { weekday: 2, session: 6, className: "5ºB" }, // martes
  { weekday: 3, session: 6, className: "4ºB" }, // miércoles
  { weekday: 4, session: 6, className: "6ºA" }  // jueves
];

/* =============== FUNCIÓN: HORAS POR MES =============== */

function getSlotsForMonth(idx) {
  const { year, month } = months[idx];
  return (year === 2026 && month === 6) ? juneSlots : defaultSlots;
}

function isFixedReservation(dateIso, slot, className) {
  const d = new Date(dateIso);
  const weekday = d.getDay(); // 1=Lun ... 5=Vie
  if (weekday < 1 || weekday > 5) return false;

  const slots = getSlotsForMonth(currentMonthIndex);
  const session = slots.indexOf(slot) + 1;

  return FIXED_WEEKLY_RESERVATIONS.some(
    f => f.weekday === weekday && f.session === session && f.className === className
  );
}

function getFixedReservationForSlot(dateIso, slot) {
  const d = new Date(dateIso);
  const weekday = d.getDay();
  if (weekday < 1 || weekday > 5) return null;

  const slots = getSlotsForMonth(currentMonthIndex);
  const session = slots.indexOf(slot) + 1;

  return FIXED_WEEKLY_RESERVATIONS.find(
    f => f.weekday === weekday && f.session === session
  );
}

/* =============== FIRESTORE =============== */

function monthDocRef(i) {
  const { year, month } = months[i];
  const id = `${year}-${String(month).padStart(2, "0")}`;
  return doc(db, "reservas_aula_informatica_celdas", id);
}

/* =============== SEMANAS ISO (PARA LÍMITE 24H) =============== */

const LOCAL_KEY = "reservas_aula_informatica_por_semana";

function getISOWeek(date) {
  const tmp = new Date(date);
  tmp.setHours(0, 0, 0, 0);

  tmp.setDate(tmp.getDate() + 4 - (tmp.getDay() || 7));

  const yearStart = new Date(tmp.getFullYear(), 0, 1);
  const week = Math.ceil((((tmp - yearStart) / 86400000) + 1) / 7);

  return { year: tmp.getFullYear(), week };
}

function weekKeyFromISO(dateIso) {
  const d = new Date(dateIso);
  const { year, week } = getISOWeek(d);
  return `${year}-W${String(week).padStart(2, "0")}`;
}

function loadWeekMap() {
  try {
    return JSON.parse(localStorage.getItem(LOCAL_KEY)) || {};
  } catch { return {}; }
}

function saveWeekMap(map) {
  localStorage.setItem(LOCAL_KEY, JSON.stringify(map));
}

function cleanExpiredWeeks() {
  const now = Date.now();
  const map = loadWeekMap();
  let changed = false;

  for (const k in map) {
    if (now - map[k].time > USER_RESERVATION_TTL_MS) {
      delete map[k];
      changed = true;
    }
  }

  if (changed) saveWeekMap(map);
  return map;
}

function getUserWeekInfo(weekKey) {
  const map = cleanExpiredWeeks();
  return map[weekKey] || null;
}

function addUserWeek(weekKey, fullId, time) {
  const map = cleanExpiredWeeks();
  map[weekKey] = { fullId, time };
  saveWeekMap(map);
}

function removeUserWeek(fullId) {
  const map = cleanExpiredWeeks();
  for (const k in map) {
    if (map[k].fullId === fullId) delete map[k];
  }
  saveWeekMap(map);
}

/* =============== UI Y RENDERIZADO =============== */

const monthSelect = document.getElementById("monthSelect");
const calendarTable = document.getElementById("calendarTable");

let currentMonthIndex = 0;
let currentData = {};
let unsubscribe = null;

months.forEach((m, i) => {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = m.name;
  monthSelect.appendChild(opt);
});

monthSelect.addEventListener("change", () => {
  subscribeToMonth(parseInt(monthSelect.value));
});

function subscribeToMonth(i) {
  if (unsubscribe) unsubscribe();
  currentMonthIndex = i;

  const ref = monthDocRef(i);
  unsubscribe = onSnapshot(ref, snap => {
    currentData = snap.exists() ? snap.data() : {};
    renderMonth(i);
  });
}

function getWeekdays(year, month) {
  const days = [];
  const date = new Date(year, month - 1, 1);

  while (date.getMonth() === month - 1) {
    const dow = date.getDay();
    if (dow >= 1 && dow <= 5) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      days.push({ iso: `${y}-${m}-${d}`, label: `${d}/${m}/${y}` });
    }
    date.setDate(date.getDate() + 1);
  }
  return days;
}

function renderMonth(i) {
  const { year, month } = months[i];
  const days = getWeekdays(year, month);
  const slots = getSlotsForMonth(i);

  calendarTable.innerHTML = "";

  const thead = document.createElement("thead");
  const tr = document.createElement("tr");

  ["Fecha", "Sesión", ...classes].forEach(txt => {
    const th = document.createElement("th");
    th.textContent = txt;
    tr.appendChild(th);
  });

  thead.appendChild(tr);
  calendarTable.appendChild(thead);

  const tbody = document.createElement("tbody");
  let alt = false;

  days.forEach(day => {
    alt = !alt;
    const rowClass = alt ? "day-a" : "day-b";

    slots.forEach(slot => {
      const tr = document.createElement("tr");
      tr.classList.add(rowClass);

      const tdDay = document.createElement("td");
      tdDay.textContent = day.label;
      tr.appendChild(tdDay);

      const tdSlot = document.createElement("td");
      tdSlot.textContent = slot;
      tr.appendChild(tdSlot);

      classes.forEach(cls => {
        const td = document.createElement("td");
        td.classList.add("reservable");
        td.dataset.date = day.iso;
        td.dataset.slot = slot;
        td.dataset.class = cls;

        const id = `${day.iso}__${slot}__${cls}`;

        if (isFixedReservation(day.iso, slot, cls)) {
          td.classList.add("fixed-reserved");
          td.dataset.fixed = "true";
        } else if (currentData[id]) {
          td.classList.add("reserved");
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  });

  calendarTable.appendChild(tbody);
}

/* =============== ACCIÓN: RESERVAR / LIBERAR =============== */

const DOUBLE_CLICK_TIME = 400;
let lastClickId = null;
let lastClickTime = 0;

calendarTable.addEventListener("click", e => {
  const cell = e.target.closest("td.reservable");
  if (!cell) return;

  const id = `${cell.dataset.date}__${cell.dataset.slot}__${cell.dataset.class}`;
  const now = Date.now();

  if (lastClickId === id && now - lastClickTime <= DOUBLE_CLICK_TIME) {
    activarCelda(cell);
    lastClickId = null;
  } else {
    lastClickId = id;
    lastClickTime = now;
  }
});

async function activarCelda(cell) {
  if (cell.dataset.fixed === "true") {
    alert("Esta franja está reservada de forma fija.");
    return;
  }

  const date = cell.dataset.date;
  const slot = cell.dataset.slot;
  const cls = cell.dataset.class;
  const id = `${date}__${slot}__${cls}`;
  const fullId = `${months[currentMonthIndex].year}-${String(months[currentMonthIndex].month).padStart(2,"0")}::${id}`;
  const value = currentData[id];
  const now = Date.now();

  /* Crear reserva */
  if (!value) {
    const wKey = weekKeyFromISO(date);
    const userInfo = getUserWeekInfo(wKey);

    if (userInfo) {
      alert("Ya tienes una reserva esta semana en las últimas 24h.");
      return;
    }

    const existing = getExistingReservationForSlot(date, slot);
    if (existing) {
      alert(`Ya reservada por ${existing.className}.`);
      return;
    }

    await setReservationValue(id, now);
    addUserWeek(wKey, fullId, now);
    return;
  }

  /* Borrar reserva (si está dentro del tiempo) */
  if (typeof value === "number") {
    if (now - value <= UNRESERVE_WINDOW_MS) {
      await clearReservation(id);
      removeUserWeek(fullId);
    } else {
      alert("No se puede modificar esta reserva.");
    }
    return;
  }

  /* Reservas antiguas */
  if (value === true) {
    await clearReservation(id);
    removeUserWeek(fullId);
  }
}

/* =============== INICIO =============== */

monthSelect.value = "0";
subscribeToMonth(0);

</script>

</body>
</html>
